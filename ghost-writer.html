<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draven | AI Ghost-Writer Engine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Marked for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase to window for React
        window.firebaseModules = { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-serif { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Markdown Styles for Chat */
        .markdown-prose h1 { font-size: 1.4em; font-weight: bold; margin-bottom: 0.5em; color: #38bdf8; }
        .markdown-prose h2 { font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; margin-top: 1em; color: #bae6fd; }
        .markdown-prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-prose strong { color: #7dd3fc; font-weight: 600; }
        .markdown-prose em { color: #94a3b8; }
        .markdown-prose blockquote { border-left: 3px solid #0ea5e9; padding-left: 1rem; color: #94a3b8; font-style: italic; }
        .markdown-prose code { background: #1e293b; padding: 0.2em 0.4em; rounded: 0.25em; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration - UPDATED WITH YOUR CLOUDFLARE WORKER ADDRESS
        const WORKER_URL = "https://unique-ue-api.unique-ue-ai-proxy.workers.dev/chat"; 
        
        const CAPABILITIES = [
            "General Assistance", "Brainstorming Ideas", "Character Development", "World-Building", 
            "Plot Structuring", "Theme Exploration", "Feedback on Drafts", "Prompts and Exercises", 
            "Editing Support", "Research Assistance", "Goal Setting", "Dialogue Assistance", 
            "Narrative Structure", "Tone and Style Guidance", "Developing Themes and Motifs", 
            "Formatting and Organization", "Idea Refinement", "Exploring Writerâ€™s Block", 
            "Genre-Specific Tips", "Creating Outlines", "Inspiration and Motivation"
        ];

        // --- Firebase Initialization Helper ---
        const useFirebase = () => {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [appId, setAppId] = useState(null);

            useEffect(() => {
                // Wait for modules to be ready or config to exist
                if (!window.firebaseModules || !window.__firebase_config) return;

                const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebaseModules;
                
                try {
                    const config = JSON.parse(window.__firebase_config);
                    const app = initializeApp(config);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    const currentAppId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

                    setAuth(authInstance);
                    setDb(dbInstance);
                    setAppId(currentAppId);

                    const initAuth = async () => {
                        try {
                            if (window.__initial_auth_token) {
                                await signInWithCustomToken(authInstance, window.__initial_auth_token);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                        } catch (error) {
                            console.error("Auth Error:", error);
                        }
                    };

                    initAuth();
                    const unsubscribe = onAuthStateChanged(authInstance, setUser);
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                }
            }, []);

            return { user, db, auth, appId };
        };

        function App() {
            // -- State --
            const { user, db, appId } = useFirebase();
            const [mode, setMode] = useState("General Assistance");
            const [messages, setMessages] = useState([
                { role: "assistant", content: "Greetings. I am Draven. I am ready to weave stories with you." }
            ]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [showSidebar, setShowSidebar] = useState(true);
            
            // Editor State
            const [activeTab, setActiveTab] = useState("manuscript"); // 'manuscript' or 'grimoire'
            const [manuscript, setManuscript] = useState("");
            const [grimoire, setGrimoire] = useState(""); // User notes/bible
            const [useContext, setUseContext] = useState(true); // "Eye of Draven" toggle
            const [status, setStatus] = useState("Connecting..."); // Saving/Saved/Offline
            
            const chatEndRef = useRef(null);
            const editorRef = useRef(null);
            const saveTimeoutRef = useRef(null);

            // -- Effects --

            // 1. Data Sync (Read/Real-time)
            useEffect(() => {
                if (!user || !db || !window.firebaseModules) {
                    setStatus("Offline (No User)");
                    return;
                }
                
                const { doc, onSnapshot } = window.firebaseModules;
                const docPath = `artifacts/${appId}/users/${user.uid}/draven_data/current_project`;
                
                setStatus("Syncing...");
                
                const unsubscribe = onSnapshot(doc(db, docPath), 
                    (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.manuscript !== manuscript) setManuscript(data.manuscript || "");
                            if (data.grimoire !== grimoire) setGrimoire(data.grimoire || "");
                            setStatus("Saved");
                        } else {
                            setStatus("New Project");
                        }
                    }, 
                    (error) => {
                        console.error("Sync Error:", error);
                        setStatus("Sync Error");
                    }
                );

                return () => unsubscribe();
            }, [user, db, appId]); 

            // 2. Auto-save (Write)
            const handleTextChange = (type, val) => {
                if (type === 'manuscript') setManuscript(val);
                else setGrimoire(val);
                
                setStatus("Unsaved changes...");
                
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                
                saveTimeoutRef.current = setTimeout(async () => {
                    if (!user || !db) return;
                    
                    setStatus("Saving...");
                    const { doc, setDoc } = window.firebaseModules;
                    const docPath = `artifacts/${appId}/users/${user.uid}/draven_data/current_project`;
                    
                    try {
                        await setDoc(doc(db, docPath), {
                            manuscript: type === 'manuscript' ? val : manuscript,
                            grimoire: type === 'grimoire' ? val : grimoire,
                            lastUpdated: new Date().toISOString()
                        }, { merge: true });
                        
                        setStatus("Saved");
                    } catch (e) {
                        console.error("Save failed", e);
                        setStatus("Save Failed");
                    }
                }, 1500); // Debounce 1.5s
            };

            // Auto-scroll chat
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // -- Logic --

            const getWordCount = (text) => {
                return text ? text.trim().split(/\s+/).filter(w => w.length > 0).length : 0;
            };

            const downloadWork = () => {
                const element = document.createElement("a");
                const file = new Blob([
                    `--- MANUSCRIPT ---\n\n${manuscript}\n\n--- THE GRIMOIRE (NOTES) ---\n\n${grimoire}`
                ], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = "draven_project_export.txt";
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const insertText = (tag) => {
                const textarea = editorRef.current;
                if (!textarea) return;
                
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = activeTab === 'manuscript' ? manuscript : grimoire;
                const selection = text.substring(start, end);
                
                let replacement = "";
                if (tag === 'b') replacement = `**${selection}**`;
                if (tag === 'i') replacement = `*${selection}*`;
                if (tag === 'h2') replacement = `\n## ${selection}\n`;
                
                const newText = text.substring(0, start) + replacement + text.substring(end);
                
                handleTextChange(activeTab, newText);
                
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(start + replacement.length, start + replacement.length);
                }, 0);
            };

            const sendMessage = async () => {
                if (!input.trim()) return;

                const newMsg = { role: "user", content: input };
                const updatedHistory = [...messages, newMsg];
                setMessages(updatedHistory);
                setInput("");
                setIsLoading(true);

                try {
                    // Prepare Context
                    let contextInjection = "";
                    if (useContext) {
                        // SEND EVERYTHING - Gemini 3.0 Pro / 2.5 Flash can handle it!
                        // No slicing required for total recall
                        contextInjection = `\n[CONTEXT DATA]\nManuscript:\n${manuscript}\n\nGrimoire/Notes:\n${grimoire}\n[END CONTEXT]\n`;
                    }

                    const payloadMessage = useContext 
                        ? `${contextInjection}\nUser Query: ${newMsg.content}`
                        : newMsg.content;

                    let reply = "";
                    
                    try {
                        const response = await fetch(WORKER_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                message: payloadMessage,
                                mode: mode,
                                history: updatedHistory.slice(-6).map(m => ({role: m.role, content: m.content})), 
                                persona: "draven"
                            })
                        });

                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        reply = data.reply;
                    } catch (err) {
                        console.warn("API Error:", err);
                        reply = `**[Connection Error]**\n\nI cannot reach the cloud brain. \n\nCheck:\n1. Is 'api-worker.js' deployed?\n2. Is the URL correct? (${WORKER_URL})`;
                    }

                    setMessages(prev => [...prev, { role: "assistant", content: reply }]);

                } catch (error) {
                    setMessages(prev => [...prev, { role: "assistant", content: "System Error." }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const appendToEditor = (text) => {
                const cleanText = text.replace(/\*\*/g, "").replace(/\[.*?\]/g, ""); 
                const currentText = activeTab === 'manuscript' ? manuscript : grimoire;
                const newText = currentText + "\n\n" + cleanText;
                handleTextChange(activeTab, newText);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="flex h-screen overflow-hidden text-sm">
                    {/* Sidebar */}
                    <div className={`${showSidebar ? 'w-64' : 'w-0'} bg-slate-900 transition-all duration-300 border-r border-slate-700 flex flex-col shrink-0`}>
                        <div className="p-4 border-b border-slate-700 bg-slate-950">
                            <h1 className="text-xl font-bold text-cyan-400 tracking-wider flex items-center gap-2">
                                <i className="fa-solid fa-ghost"></i> DRAVEN
                            </h1>
                            <p className="text-xs text-slate-500 mt-1">Ghost-Writer Engine v3.0</p>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-3 space-y-1">
                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 mt-2 px-2">Focus Mode</p>
                            {CAPABILITIES.map(cap => (
                                <button
                                    key={cap}
                                    onClick={() => setMode(cap)}
                                    className={`w-full text-left px-3 py-2 rounded transition-all ${
                                        mode === cap 
                                        ? 'bg-cyan-900/30 text-cyan-300 border-l-2 border-cyan-500 font-medium' 
                                        : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-2 border-transparent'
                                    }`}
                                >
                                    {cap}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Area */}
                    <div className="flex-1 flex flex-col min-w-0 bg-slate-950">
                        
                        {/* Top Bar */}
                        <div className="h-12 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setShowSidebar(!showSidebar)} className="text-slate-400 hover:text-white transition-colors">
                                    <i className="fa-solid fa-bars"></i>
                                </button>
                                <div className="flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
                                    <span className="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                                    <span className="text-xs text-cyan-100 font-mono uppercase">{mode}</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="text-xs flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 text-slate-400">
                                    <i className={`fa-solid fa-circle text-[8px] ${
                                        status === 'Saved' ? 'text-green-400' : 
                                        status.includes('Sync') ? 'text-blue-400' : 
                                        'text-yellow-400'
                                    }`}></i>
                                    {status}
                                </div>
                                <button 
                                    onClick={downloadWork}
                                    className="text-slate-400 hover:text-emerald-400 text-xs flex items-center gap-2 transition-colors border-l border-slate-700 pl-4"
                                    title="Download .txt"
                                >
                                    <i className="fa-solid fa-download"></i> Export
                                </button>
                            </div>
                        </div>

                        {/* Workspace Split */}
                        <div className="flex-1 flex overflow-hidden">
                            
                            {/* LEFT: Chat */}
                            <div className="flex-1 flex flex-col border-r border-slate-700 bg-slate-900/40 min-w-[320px]">
                                <div className="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            {msg.role === 'assistant' && (
                                                <div className="w-8 h-8 rounded-full bg-cyan-950 border border-cyan-800 flex-shrink-0 flex items-center justify-center text-cyan-500 mt-1 shadow-lg shadow-cyan-900/20">
                                                    <i className="fa-solid fa-feather-pointed"></i>
                                                </div>
                                            )}
                                            
                                            <div className={`max-w-[90%] rounded-xl p-4 shadow-md ${
                                                msg.role === 'user' 
                                                ? 'bg-blue-600 text-white rounded-br-none' 
                                                : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-bl-none'
                                            }`}>
                                                <div 
                                                    className="markdown-prose text-sm"
                                                    dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} 
                                                />
                                                {msg.role === 'assistant' && (
                                                    <div className="mt-3 pt-2 border-t border-slate-700/50 flex justify-end">
                                                        <button 
                                                            onClick={() => appendToEditor(msg.content)}
                                                            className="text-[10px] uppercase tracking-wider font-bold text-cyan-500 hover:text-cyan-300 flex items-center gap-1 transition-colors"
                                                        >
                                                            <i className="fa-solid fa-arrow-right-to-bracket"></i> Push to {activeTab}
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && (
                                        <div className="flex gap-3 animate-pulse">
                                            <div className="w-8 h-8 rounded-full bg-cyan-950 border border-cyan-800 flex items-center justify-center text-cyan-500">
                                                <i className="fa-solid fa-feather-pointed"></i>
                                            </div>
                                            <div className="text-cyan-700 text-xs flex items-center">Draven is thinking...</div>
                                        </div>
                                    )}
                                    <div ref={chatEndRef} />
                                </div>

                                {/* Chat Input Area */}
                                <div className="p-4 bg-slate-900 border-t border-slate-700 z-10">
                                    <div className="flex items-center justify-between mb-2 px-1">
                                        <label className="flex items-center gap-2 cursor-pointer group">
                                            <div className={`w-3 h-3 rounded-full border ${useContext ? 'bg-green-500 border-green-500' : 'bg-transparent border-slate-500'}`}></div>
                                            <span className={`text-xs ${useContext ? 'text-green-400' : 'text-slate-500'} group-hover:text-slate-300 transition-colors`}>
                                                Read {activeTab} (Context)
                                            </span>
                                            <input type="checkbox" className="hidden" checked={useContext} onChange={() => setUseContext(!useContext)} />
                                        </label>
                                        <button 
                                            onClick={() => setMessages([])} 
                                            className="text-xs text-slate-600 hover:text-red-400 transition-colors"
                                            title="Clear Chat History"
                                        >
                                            <i className="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                    <div className="relative">
                                        <textarea
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyDown={handleKeyDown}
                                            placeholder={`Ask Draven to write, edit, or critique...`}
                                            className="w-full bg-slate-950 text-slate-200 rounded-lg pl-4 pr-12 py-3 border border-slate-800 focus:outline-none focus:border-cyan-700 focus:ring-1 focus:ring-cyan-700 resize-none h-16 shadow-inner text-sm"
                                        ></textarea>
                                        <button 
                                            onClick={sendMessage}
                                            disabled={isLoading || !input.trim()}
                                            className="absolute right-3 top-3 p-2 bg-cyan-900/20 hover:bg-cyan-900/50 text-cyan-500 rounded transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                                        >
                                            <i className="fa-solid fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* RIGHT: Editor Suite */}
                            <div className="flex-1 bg-slate-100 flex flex-col relative min-w-[400px]">
                                
                                {/* Editor Tabs */}
                                <div className="bg-white border-b border-slate-200 px-4 flex items-end gap-1 shadow-sm h-10 shrink-0">
                                    <button 
                                        onClick={() => setActiveTab('manuscript')}
                                        className={`px-4 py-2 text-xs font-bold uppercase tracking-wide rounded-t-lg transition-all ${
                                            activeTab === 'manuscript' 
                                            ? 'bg-slate-100 text-slate-900 border-x border-t border-slate-200 translate-y-[1px]' 
                                            : 'bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600'
                                        }`}
                                    >
                                        <i className="fa-solid fa-book mr-2"></i> Manuscript
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('grimoire')}
                                        className={`px-4 py-2 text-xs font-bold uppercase tracking-wide rounded-t-lg transition-all ${
                                            activeTab === 'grimoire' 
                                            ? 'bg-slate-100 text-purple-900 border-x border-t border-slate-200 translate-y-[1px]' 
                                            : 'bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600'
                                        }`}
                                    >
                                        <i className="fa-solid fa-hat-wizard mr-2"></i> Grimoire (Notes)
                                    </button>
                                </div>

                                {/* Formatting Toolbar */}
                                <div className="bg-slate-50 border-b border-slate-200 px-4 py-2 flex gap-2 shrink-0 items-center justify-between">
                                    <div className="flex gap-2">
                                        <button onClick={() => insertText('b')} className="w-8 h-8 rounded hover:bg-slate-200 text-slate-600 font-bold font-serif" title="Bold">B</button>
                                        <button onClick={() => insertText('i')} className="w-8 h-8 rounded hover:bg-slate-200 text-slate-600 italic font-serif" title="Italic">I</button>
                                        <div className="w-px h-6 bg-slate-300 my-auto mx-1"></div>
                                        <button onClick={() => insertText('h2')} className="px-3 h-8 rounded hover:bg-slate-200 text-slate-600 font-bold text-xs" title="Heading">H2</button>
                                    </div>
                                    <div className="text-xs text-slate-400 font-mono">
                                        <span className="text-slate-500">WORDS:</span> <span className="text-cyan-600 font-bold">{getWordCount(activeTab === 'manuscript' ? manuscript : grimoire)}</span>
                                    </div>
                                </div>

                                {/* Text Area */}
                                <div className="flex-1 relative group">
                                    <textarea
                                        ref={editorRef}
                                        value={activeTab === 'manuscript' ? manuscript : grimoire}
                                        onChange={(e) => handleTextChange(activeTab, e.target.value)}
                                        className={`absolute inset-0 w-full h-full p-8 bg-white outline-none text-lg leading-relaxed resize-none ${
                                            activeTab === 'manuscript' 
                                            ? 'font-serif text-slate-900' 
                                            : 'font-mono text-sm text-purple-900 bg-purple-50/30'
                                        }`}
                                        placeholder={activeTab === 'manuscript' ? "Start your story here..." : "Character names, locations, magic systems, and plot bunnies go here..."}
                                    ></textarea>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
